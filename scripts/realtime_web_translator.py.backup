#!/usr/bin/env python3

import asyncio
import logging
import sys
import os
from pathlib import Path
import requests
import websockets
import json

sys.path.insert(0, str(Path(__file__).parent.parent))

from dotenv import load_dotenv
from openai import AsyncAzureOpenAI
import uvicorn

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ—Ç–æ—Ä—ã–π –º—ã —Å–æ–∑–¥–∞–ª–∏
from app.realtime_translator.web_interface import get_web_interface

load_dotenv()

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

API_KEY = os.getenv('RECALL_API_KEY')
BASE_URL = 'https://us-west-2.recall.ai/api/v1'
AZURE_OPENAI_KEY = os.getenv('AZURE_OPENAI_KEY')
AZURE_OPENAI_ENDPOINT = os.getenv('AZURE_OPENAI_ENDPOINT')
AZURE_OPENAI_DEPLOYMENT = os.getenv('AZURE_OPENAI_DEPLOYMENT_QUALITY')  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å
AZURE_OPENAI_API_VERSION = "2024-08-01-preview"

class RealtimeTranslator:
    def __init__(self, meeting_url: str):
        self.meeting_url = meeting_url
        self.bot_id = None
        self.openai_client = AsyncAzureOpenAI(
            api_key=AZURE_OPENAI_KEY,
            api_version=AZURE_OPENAI_API_VERSION,
            azure_endpoint=AZURE_OPENAI_ENDPOINT
        )
        self.web = get_web_interface()
        self.headers = {
            'Authorization': f'Token {API_KEY}',
            'Content-Type': 'application/json'
        }
async def create_bot(self):
        """–°–æ–∑–¥–∞—ë–º –±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π API"""
        logger.info("Creating Recall bot...")
        
        bot_data = {
            "meeting_url": self.meeting_url,
            "bot_name": "AI Translator Bot"
        }
        
        response = requests.post(
            f'{BASE_URL}/bot',
            json=bot_data,
            headers=self.headers
        )
        
        if response.status_code == 201:
            bot = response.json()
            self.bot_id = bot['id']
            logger.info(f"‚úì Bot created: {self.bot_id}")
            
            await self.web.broadcast({
                "type": "system",
                "message": f"Bot connected to meeting"
            })
            
            return True
        else:
            logger.error(f"Failed to create bot: {response.text}")
            return False
    
    async def connect_websocket(self):
        """–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π"""
        ws_url = f"wss://us-west-2.recall.ai/api/v1/bot/{self.bot_id}/transcript"
        
        logger.info("Connecting to transcript WebSocket...")
        
        try:
            async with websockets.connect(
                ws_url,
                extra_headers={"Authorization": f"Token {API_KEY}"}
            ) as websocket:
                logger.info("‚úì WebSocket connected, waiting for transcripts...")
                
                await self.web.broadcast({
                    "type": "system",
                    "message": "Listening to meeting..."
                })
                
                async for message in websocket:
                    try:
                        data = json.loads(message)
                        await self.handle_transcript(data)
                    except Exception as e:
                        logger.error(f"Error handling message: {e}")
        
        except Exception as e:
            logger.error(f"WebSocket error: {e}")
    
    async def handle_transcript(self, data: dict):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º"""
        try:
            speaker = data.get('speaker', 'Unknown')
            text = data.get('words', '').strip()
            
            if not text:
                return
            
            logger.info(f"{speaker}: {text}")
            
            # –ü–µ—Ä–µ–≤–æ–¥–∏–º —á–µ—Ä–µ–∑ GPT-4o
            translation = await self.translate(text)
            logger.info(f"‚Üí {translation}")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            await self.web.broadcast({
                "type": "translation",
                "speaker": speaker,
                "original": text,
                "translation": translation
            })
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Zoom —á–∞—Ç
            await self.send_to_zoom_chat(f"[{speaker}] {translation}")
        
        except Exception as e:
            logger.error(f"Error in handle_transcript: {e}")
    
    async def translate(self, text: str) -> str:
        """–ü–µ—Ä–µ–≤–æ–¥–∏–º —á–µ—Ä–µ–∑ GPT-4o"""
        try:
            response = await self.openai_client.chat.completions.create(
                model="AZURE_OPENAI_DEPLOYMENT",
                messages=[
                    {
                        "role": "system",
                        "content": "You are a professional translator. Translate Russian to English. Provide only the translation, no explanations."
                    },
                    {
                        "role": "user",
                        "content": text
                    }
                ],
                temperature=0.3,
                max_tokens=1000
            )
            return response.choices[0].message.content.strip()
        
        except Exception as e:
            logger.error(f"Translation error: {e}")
            return f"[Translation error]"
    
    async def send_to_zoom_chat(self, message: str):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Zoom —á–∞—Ç"""
        try:
            response = requests.post(
                f'{BASE_URL}/bot/{self.bot_id}/send_chat_message',
                json={"message": message},
                headers=self.headers
            )
            if response.status_code != 200:
                logger.error(f"Failed to send chat: {response.text}")
        except Exception as e:
            logger.error(f"Error sending to Zoom: {e}")
    
    async def start(self):
        """–ó–∞–ø—É—Å–∫–∞–µ–º –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å"""
        try:
            # –°–æ–∑–¥–∞—ë–º –±–æ—Ç–∞
            if not await self.create_bot():
                return
            
            # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è–º
            await self.connect_websocket()
        
        except Exception as e:
            logger.error(f"Error in start: {e}")
    
    async def stop(self):
        """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞"""
        if self.bot_id:
            try:
                response = requests.delete(
                    f'{BASE_URL}/bot/{self.bot_id}',
                    headers=self.headers
                )
                logger.info("‚úì Bot deleted")
            except Exception as e:
                logger.error(f"Error deleting bot: {e}")

# Global instance
translator = None

async def run_translator(meeting_url: str):
    global translator
    translator = RealtimeTranslator(meeting_url)
    await translator.start()

def read_meeting_url_from_config():
    """–ß–∏—Ç–∞–µ—Ç URL –∏–∑ –∫–æ–Ω—Ñ–∏–≥ —Ñ–∞–π–ª–∞"""
    config_file = Path(__file__).parent.parent / "config" / "zoom_meeting.conf"
    
    if config_file.exists():
        with open(config_file, 'r') as f:
            for line in f:
                line = line.strip()
                if line.startswith('MEETING_URL='):
                    return line.split('=', 1)[1]
    
    return None

def main():
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å URL
    if len(sys.argv) >= 2:
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
        meeting_url = sys.argv[1]
    else:
        # –ò–Ω–∞—á–µ –±–µ—Ä—ë–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
        meeting_url = read_meeting_url_from_config()
    
    if not meeting_url:
        print("‚ùå No meeting URL provided!")
        print("\nUsage:")
        print("  1. python3 scripts/realtime_web_translator.py <ZOOM_URL>")
        print("  2. Or edit config/zoom_meeting.conf and run without arguments")
        sys.exit(1)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–∏
    if not API_KEY:
        print("‚ùå RECALL_API_KEY not found in .env")
        sys.exit(1)
    
    if not AZURE_OPENAI_KEY:
        print("‚ùå AZURE_OPENAI_KEY not found in .env")
        sys.exit(1)
    
    if not AZURE_OPENAI_ENDPOINT:
        print("‚ùå AZURE_OPENAI_ENDPOINT not found in .env")
        sys.exit(1)
    
    logger.info("="*60)
    logger.info("üåê Zoom Real-Time Translator")
    logger.info("="*60)
    logger.info(f"üìπ Meeting: {meeting_url}")
    logger.info(f"üîë Recall API: {'‚úì' if API_KEY else '‚úó'}")
    logger.info(f"ü§ñ Azure OpenAI: {'‚úì' if AZURE_OPENAI_KEY else '‚úó'}")
    logger.info(f"üì¶ Deployment: {AZURE_OPENAI_DEPLOYMENT}")

    logger.info("="*60)
    
    # –ü–æ–ª—É—á–∞–µ–º –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    web = get_web_interface()
    
    @web.app.on_event("startup")
    async def startup():
        asyncio.create_task(run_translator(meeting_url))
    
    @web.app.on_event("shutdown")
    async def shutdown():
        if translator:
            await translator.stop()
    
    port = int(os.getenv('WEB_PORT', 8000))
    
    logger.info(f"üåê Web interface: http://172.205.192.158:{port}")
    logger.info("="*60)
    logger.info("Press Ctrl+C to stop")
    logger.info("="*60 + "\n")
    
    uvicorn.run(web.app, host="0.0.0.0", port=port)

if __name__ == "__main__":
    main()
