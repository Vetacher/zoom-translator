<!DOCTYPE html>
<html>
<head>
    <title>Zoom Meeting Bot</title>
    <meta charset="utf-8">
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        #meeting-container { width: 100%; height: 600px; }
        #status { margin: 20px 0; padding: 10px; background: #f0f0f0; }
        .log { font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div id="status">
        <div>Status: <span id="status-text">Initializing...</span></div>
        <div class="log" id="log"></div>
    </div>
    
    <div id="meeting-container"></div>

    <!-- Zoom Web SDK -->
    <script src="https://source.zoom.us/3.9.0/lib/vendor/react.min.js"></script>
    <script src="https://source.zoom.us/3.9.0/lib/vendor/react-dom.min.js"></script>
    <script src="https://source.zoom.us/3.9.0/lib/vendor/redux.min.js"></script>
    <script src="https://source.zoom.us/3.9.0/lib/vendor/redux-thunk.min.js"></script>
    <script src="https://source.zoom.us/3.9.0/lib/vendor/lodash.min.js"></script>
    <script src="https://source.zoom.us/zoom-meeting-3.9.0.min.js"></script>

    <script>
        const statusEl = document.getElementById('status-text');
        const logEl = document.getElementById('log');
        
        function log(message) {
            console.log(message);
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}<br>`;
        }
        
        function setStatus(text) {
            statusEl.textContent = text;
            log(text);
        }
        
        // Получаем параметры из URL
        const urlParams = new URLSearchParams(window.location.search);
        const meetingNumber = urlParams.get('meetingNumber');
        const userName = urlParams.get('userName') || 'AI Translator Bot';
        const passWord = urlParams.get('password') || '';
        const sdkKey = urlParams.get('sdkKey');
        const sdkSecret = urlParams.get('sdkSecret');
        
        setStatus('Initializing Zoom Web SDK...');
        
        // Инициализация Zoom SDK
        ZoomMtg.setZoomJSLib('https://source.zoom.us/3.9.0/lib', '/av');
        ZoomMtg.preLoadWasm();
        ZoomMtg.prepareWebSDK();
        
        // Генерация JWT токена (упрощённая версия для клиента)
        function generateSignature(sdkKey, sdkSecret, meetingNumber, role) {
            // В production это должно делаться на сервере!
            const iat = Math.round(new Date().getTime() / 1000) - 30;
            const exp = iat + 60 * 60 * 2;
            
            const oHeader = { alg: 'HS256', typ: 'JWT' };
            const oPayload = {
                sdkKey: sdkKey,
                mn: meetingNumber,
                role: role,
                iat: iat,
                exp: exp,
                appKey: sdkKey,
                tokenExp: exp
            };
            
            // Используем библиотеку для JWT (должна быть добавлена)
            return 'SIGNATURE_PLACEHOLDER'; // Заменим на серверную генерацию
        }
        
        // Подключение к встрече
        function joinMeeting() {
            setStatus('Joining meeting...');
            
            ZoomMtg.init({
                leaveUrl: window.location.origin,
                success: function(success) {
                    log('Init success');
                    
                    ZoomMtg.join({
                        meetingNumber: meetingNumber,
                        userName: userName,
                        signature: generateSignature(sdkKey, sdkSecret, meetingNumber, 0),
                        sdkKey: sdkKey,
                        passWord: passWord,
                        
                        success: function(success) {
                            setStatus('Connected to meeting!');
                            log('Join success');
                            
                            // Захват аудио
                            setupAudioCapture();
                        },
                        
                        error: function(error) {
                            setStatus('Failed to join: ' + error.reason);
                            log('Join error: ' + JSON.stringify(error));
                        }
                    });
                },
                error: function(error) {
                    setStatus('Init failed: ' + error.reason);
                    log('Init error: ' + JSON.stringify(error));
                }
            });
        }
        
        // Захват аудио для отправки в Azure
        function setupAudioCapture() {
            log('Setting up audio capture...');
            
            // Получаем аудио стрим
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    log('Audio stream captured');
                    
                    // Создаём AudioContext для обработки
                    const audioContext = new AudioContext();
                    const source = audioContext.createMediaStreamSource(stream);
                    const processor = audioContext.createScriptProcessor(4096, 1, 1);
                    
                    processor.onaudioprocess = function(e) {
                        const audioData = e.inputBuffer.getChannelData(0);
                        
                        // Отправляем аудио данные на сервер через WebSocket
                        if (window.audioSocket && window.audioSocket.readyState === WebSocket.OPEN) {
                            // Конвертируем Float32Array в Int16Array для Azure
                            const int16Data = new Int16Array(audioData.length);
                            for (let i = 0; i < audioData.length; i++) {
                                int16Data[i] = Math.max(-32768, Math.min(32767, audioData[i] * 32768));
                            }
                            window.audioSocket.send(int16Data.buffer);
                        }
                    };
                    
                    source.connect(processor);
                    processor.connect(audioContext.destination);
                    
                    // Подключаемся к WebSocket серверу для отправки аудио
                    connectToAudioServer();
                })
                .catch(err => {
                    log('Audio capture error: ' + err.message);
                });
        }
        
        // Подключение к WebSocket серверу для передачи аудио
        function connectToAudioServer() {
            const wsUrl = 'ws://' + window.location.hostname + ':8765/audio';
            log('Connecting to audio server: ' + wsUrl);
            
            window.audioSocket = new WebSocket(wsUrl);
            
            window.audioSocket.onopen = function() {
                log('Audio WebSocket connected');
            };
            
            window.audioSocket.onmessage = function(event) {
                // Получаем переведённый текст обратно
                log('Translation: ' + event.data);
            };
            
            window.audioSocket.onerror = function(error) {
                log('WebSocket error: ' + error);
            };
        }
        
        // Запускаем подключение при загрузке
        if (meetingNumber && sdkKey) {
            window.onload = joinMeeting;
        } else {
            setStatus('Error: Missing meeting parameters');
        }
    </script>
</body>
</html>
